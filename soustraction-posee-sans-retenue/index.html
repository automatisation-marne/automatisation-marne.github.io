<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Soustraction posée interactive</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 30px; }
    table { margin: 20px auto; border-collapse: collapse; }
    td { border: 1px solid #aaa; width: 40px; height: 40px; font-size: 24px; text-align: center; }
    input { width: 100%; height: 100%; font-size: 24px; text-align: center; border: none; }
    button, select { margin: 10px; padding: 10px 20px; font-size: 18px; }
    .correct { background-color: #c8f7c5; }
    .incorrect { background-color: #f7c5c5; }
    #app, #exercise { display: none; }
  </style>
</head>
<body>
  <div id="login">
    <h1>Choisis ton animal</h1>
    <select id="animalSelect">
      <option disabled selected value="">-- Choisis ton animal --</option>
      <option>Axolotl</option>
      <option>Boa</option>
      <option>Chat</option>
      <option>Chien</option>
      <option>Chouette</option>
      <option>Furet</option>
      <option>Gecko</option>
      <option>Grue</option>
      <option>Koala</option>
      <option>Lapin</option>
      <option>Lézard</option>
      <option>Loup</option>
      <option>Lynx</option>
      <option>Oie</option>
      <option>Otarie</option>
      <option>Ours</option>
      <option>Panda</option>
      <option>Puma</option>
      <option>Renard</option>
      <option>Tigre</option>
    </select>
    <br><br>
    <button onclick="startApp()">Commencer</button>
  </div>

  <div id="app">
    <h2 id="animalDisplay"></h2>
    <label for="digits">Nombre de chiffres :</label>
    <select id="digits">
      <option value="2">2 chiffres</option>
      <option value="3" selected>3 chiffres</option>
      <option value="4">4 chiffres</option>
    </select>

    <br><br>
    <button onclick="generateProblem()">Nouvelle soustraction</button>
    <button onclick="checkAnswer()">Vérifier</button>

    <div id="exercise">
      <table>
        <tbody id="problemTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    let minuend = 0;
    let subtrahend = 0;
    let currentAnimal = "";

    function startApp() {
      const animal = document.getElementById("animalSelect").value;
      if (!animal) return alert("Choisis ton animal pour commencer.");
      currentAnimal = animal;
      document.getElementById("animalDisplay").textContent = "Animal : " + animal;
      document.getElementById("login").style.display = "none";
      document.getElementById("app").style.display = "block";
    }

    function generateProblem() {
      const digits = parseInt(document.getElementById('digits').value);
      const min = Math.pow(10, digits - 1);
      const max = Math.pow(10, digits) - 1;

      do {
        minuend = Math.floor(Math.random() * (max - min + 1)) + min;
        subtrahend = Math.floor(Math.random() * (max - min + 1)) + min;
      } while (subtrahend > minuend || hasRetenue(minuend, subtrahend));

      displayProblem(minuend, subtrahend);
    }

    function hasRetenue(a, b) {
      const aStr = a.toString().padStart(Math.max(a.toString().length, b.toString().length), '0');
      const bStr = b.toString().padStart(aStr.length, '0');
      for (let i = aStr.length - 1; i >= 0; i--) {
        if (parseInt(bStr[i]) > parseInt(aStr[i])) return true;
      }
      return false;
    }

    function displayProblem(a, b) {
      const table = document.getElementById("problemTable");
      table.innerHTML = "";

      const aStr = a.toString();
      const bStr = b.toString().padStart(aStr.length, ' ');
      const answerLength = aStr.length;

      const row1 = document.createElement("tr");
      const row2 = document.createElement("tr");
      const row3 = document.createElement("tr");

      row1.appendChild(document.createElement("td"));
      const minusCell = document.createElement("td");
      minusCell.textContent = "-";
      row2.appendChild(minusCell);
      row3.appendChild(document.createElement("td"));

      for (let i = 0; i < answerLength; i++) {
        const td1 = document.createElement("td");
        td1.textContent = aStr[i];
        row1.appendChild(td1);

        const td2 = document.createElement("td");
        td2.textContent = bStr[i] === ' ' ? '' : bStr[i];
        row2.appendChild(td2);

        const td3 = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.maxLength = 1;
        td3.appendChild(input);
        row3.appendChild(td3);
      }

      table.appendChild(row1);
      table.appendChild(row2);
      const line = document.createElement("tr");
      const hr = document.createElement("td");
      hr.colSpan = answerLength + 1;
      hr.innerHTML = "<hr>";
      line.appendChild(hr);
      table.appendChild(line);
      table.appendChild(row3);

      document.getElementById("exercise").style.display = "block";
    }

    function checkAnswer() {
      const inputs = document.querySelectorAll("#problemTable input");
      const userAnswer = Array.from(inputs).map(input => input.value || ' ').join('').trim();
      const correctAnswer = (minuend - subtrahend).toString();

      inputs.forEach((input, idx) => {
        const expected = correctAnswer.padStart(inputs.length, ' ')[idx];
        if ((input.value || ' ') === expected) {
          input.className = 'correct';
        } else {
          input.className = 'incorrect';
        }
      });
    }
  </script>
</body>
</html>
