<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Soustraction posée interactive</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 30px; }
    table { margin: 20px auto; border-collapse: collapse; position: relative; }
    td { border: 1px solid #aaa; width: 40px; height: 40px; font-size: 24px; text-align: center; position: relative; }
    input { width: 100%; height: 100%; font-size: 24px; text-align: center; border: none; }
    button, select { margin: 10px; padding: 10px 20px; font-size: 18px; }

    .correct { background-color: #c8f7c5; }
    .incorrect { background-color: #f7c5c5; }

    .centaine { background-color: #add8e6; }
    .dizaine { background-color: #ffa500; }
    .unite { background-color: #ffff66; }

    .cassure {
      position: absolute;
      top: 0;
      left: 2px;
      font-size: 24px;
      color: red;
      opacity: 0.7;
      pointer-events: none;
    }

    .barre-valeur {
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      color: red;
      font-size: 18px;
      font-weight: bold;
      pointer-events: none;
    }

    .clavier {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 5px;
      z-index: 1000;
    }

    .clavier button {
      width: 40px;
      height: 40px;
      margin: 2px;
      font-size: 18px;
    }

    #exercise, #controls { display: none; }
  </style>
</head>
<body>

  <div id="selection">
    <h2>Choisis ton animal</h2>
    <select id="animalSelect">
      <option value="">-- Sélectionne ton animal --</option>
      <option value="Axolotl">Axolotl</option>
      <option value="Boa">Boa</option>
      <option value="Chat">Chat</option>
      <option value="Chien">Chien</option>
      <option value="Chouette">Chouette</option>
      <option value="Furet">Furet</option>
      <option value="Gecko">Gecko</option>
      <option value="Grue">Grue</option>
      <option value="Koala">Koala</option>
      <option value="Lapin">Lapin</option>
      <option value="Lézard">Lézard</option>
      <option value="Loup">Loup</option>
      <option value="Lynx">Lynx</option>
      <option value="Oie">Oie</option>
      <option value="Otarie">Otarie</option>
      <option value="Ours">Ours</option>
      <option value="Panda">Panda</option>
      <option value="Puma">Puma</option>
      <option value="Renard">Renard</option>
      <option value="Tigre">Tigre</option>
    </select>
    <br><br>
    <button onclick="startExercise()">Choisis</button>
  </div>

  <div id="controls">
    <h1>Soustraction posée avec retenue</h1>
    <button onclick="generateProblem()">Nouvelle soustraction</button>
    <button onclick="checkAnswer()">Vérifier</button>
    <label for="digitSelectLive">Type :</label>
    <select id="digitSelectLive" onchange="updateDigits()">
      <option value="2">2 chiffres</option>
      <option value="3" selected>3 chiffres</option>
      <option value="4">4 chiffres</option>
    </select>
  </div>

  <div id="exercise">
    <table>
      <tbody id="problemTable"></tbody>
    </table>
  </div>

  <div id="clavier" class="clavier" style="display:none;"></div>

  <script>
let currentAnimal = "";
let digits = 3;
let minuend = 0;
let subtrahend = 0;
let currentInput = null;

function startExercise() {
  const select = document.getElementById("animalSelect");
  if (!select.value) {
    alert("Tu dois d'abord choisir ton animal.");
    return;
  }
  currentAnimal = select.value;
  document.getElementById("selection").style.display = "none";
  document.getElementById("controls").style.display = "block";
  document.getElementById("exercise").style.display = "block";
  generateProblem();
}

function updateDigits() {
  digits = parseInt(document.getElementById("digitSelectLive").value);
  generateProblem();
}

function generateProblem() {
  const min = Math.pow(10, digits - 1);
  const max = Math.pow(10, digits) - 1;
  do {
    minuend = Math.floor(Math.random() * (max - min + 1)) + min;
    subtrahend = Math.floor(Math.random() * (max - min + 1)) + min;
  } while (subtrahend > minuend);
  displayProblem(minuend, subtrahend);
}

function getClassByPosition(pos, len) {
  if (pos === len - 1) return 'unite';
  if (pos === len - 2) return 'dizaine';
  if (pos === len - 3) return 'centaine';
  return '';
}

function displayProblem(a, b) {
  const table = document.getElementById("problemTable");
  table.innerHTML = "";
  const aStr = a.toString();
  const bStr = b.toString().padStart(aStr.length, ' ');
  const len = aStr.length;
  const row1 = document.createElement("tr");
  const row2 = document.createElement("tr");
  const row3 = document.createElement("tr");
  row1.appendChild(document.createElement("td"));
  const minusCell = document.createElement("td");
  minusCell.textContent = "-";
  row2.appendChild(minusCell);
  row3.appendChild(document.createElement("td"));

  for (let i = 0; i < len; i++) {
    const cls = getClassByPosition(i, len);
    const td1 = document.createElement("td");
    td1.className = cls;
    td1.textContent = aStr[i];
    td1.onclick = () => handleRetenue(td1);

    const td2 = document.createElement("td");
    td2.className = cls;
    td2.textContent = bStr[i] === ' ' ? '' : bStr[i];

    const td3 = document.createElement("td");
    const input = document.createElement("input");
    input.type = "text";
    input.maxLength = 1;
    input.onclick = function (e) {
      e.stopPropagation();
      showKeyboard(this);
    };
    td3.appendChild(input);

    row1.appendChild(td1);
    row2.appendChild(td2);
    row3.appendChild(td3);
  }
  const line = document.createElement("tr");
  const hr = document.createElement("td");
  hr.colSpan = len + 1;
  hr.innerHTML = "<hr>";
  line.appendChild(hr);
  table.appendChild(row1);
  table.appendChild(row2);
  table.appendChild(line);
  table.appendChild(row3);
}

function handleRetenue(td) {
  if (td.classList.contains("barred")) {
    td.classList.remove("barred");
    td.querySelectorAll(".barre-valeur, .cassure, div").forEach(e => e.remove());

    let next = td.nextSibling;
    while (next && next.tagName === 'TD') {
      next.querySelectorAll(".cassure").forEach(e => e.remove());
      next = next.nextSibling;
    }

    let prev = td.previousSibling;
    while (prev && prev.tagName === 'TD') {
      prev.querySelectorAll(".barre-valeur, div").forEach(e => e.remove());
      prev.classList.remove("barred");
      prev = prev.previousSibling;
    }

    const row = td.parentElement;
    row.querySelectorAll("div").forEach(div => div.remove()); // Supprime la barre horizontale
    return;
  }

  const valeur = parseInt(td.textContent);
  if (valeur === 0 && td.previousSibling) {
    let prev = td.previousSibling;
    while (prev && parseInt(prev.textContent) === 0) {
      prev = prev.previousSibling;
    }
    if (prev && !prev.classList.contains("barred")) {
      let current = td;
      const updateCells = [];

      // Marquer tous les 0 jusqu’à prev
      while (current !== prev) {
        if (parseInt(current.textContent) === 0) {
          updateCells.push(current);
        }
        current = current.previousSibling;
      }

      prev.classList.add("barred");
      const prevVal = parseInt(prev.textContent);
      const spanPrev = document.createElement("span");
      spanPrev.className = "barre-valeur";
      spanPrev.textContent = prevVal - 1;
      prev.appendChild(spanPrev);

      // Appliquer 9 à tous les 0 entre prev et td
      updateCells.reverse().forEach(cell => {
        cell.classList.add("barred");
        const span = document.createElement("span");
        span.className = "barre-valeur";
        span.textContent = "9";
        cell.appendChild(span);
      });

      const firstCell = updateCells[0];
      const next = td.nextSibling;
      if (next && next.tagName === 'TD') {
        const cassure = document.createElement("span");
        cassure.className = "cassure";
        cassure.textContent = "1";
        next.insertBefore(cassure, next.firstChild);
      }

      // Dessiner barre horizontale
      const barre = document.createElement("div");
      barre.style.position = "absolute";
      barre.style.height = "2px";
      barre.style.background = "black";
      barre.style.top = td.offsetHeight / 2 + "px";
      barre.style.left = prev.offsetLeft - td.parentElement.offsetLeft + "px";
      barre.style.width = (td.offsetLeft - prev.offsetLeft + td.offsetWidth) + "px";
      barre.style.zIndex = 10;
      td.parentElement.appendChild(barre);
    }
  } else if (!isNaN(valeur) && valeur > 0) {
    td.classList.add("barred");
    const spanVal = document.createElement("span");
    spanVal.className = "barre-valeur";
    spanVal.textContent = valeur - 1;
    td.appendChild(spanVal);
    const next = td.nextSibling;
    if (next && next.tagName === 'TD') {
      const span = document.createElement("span");
      span.className = "cassure";
      span.textContent = "1";
      next.insertBefore(span, next.firstChild);
    }
    const barreDiag = document.createElement("div");
    barreDiag.style.position = "absolute";
    barreDiag.style.width = "100%";
    barreDiag.style.height = "2px";
    barreDiag.style.background = "black";
    barreDiag.style.top = "50%";
    barreDiag.style.left = "0";
    barreDiag.style.transform = "rotate(-45deg)";
    barreDiag.style.transformOrigin = "center";
    td.appendChild(barreDiag);
  }
}


function checkAnswer() {
  const inputs = document.querySelectorAll("#problemTable input");
  const userAnswer = Array.from(inputs).map(i => i.value || '0').join('');
  const correct = (minuend - subtrahend).toString().padStart(inputs.length, '0');
  let score = 0;
  inputs.forEach((input, i) => {
    if (input.value === correct[i]) {
      input.className = "correct";
      score++;
    } else {
      input.className = "incorrect";
    }
  });
  const finalScore = Math.round((score / inputs.length) * 100);
  const formURL = "https://docs.google.com/forms/d/e/1FAIpQLSc8gL0iLCLF1f26l6UMo9FC8W72qn7gh1OfL6TQmtzsq3MZRg/formResponse";
  fetch(formURL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      "entry.2043306579": currentAnimal,
      "entry.458588301": finalScore,
      "entry.1442182901": "Soustraction posée avec retenue"
    })
  });
}

function showKeyboard(input) {
  currentInput = input;
  const clavier = document.getElementById("clavier");
  clavier.innerHTML = '';
  for (let i = 1; i <= 9; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.onclick = () => { input.value = i; hideKeyboard(); };
    clavier.appendChild(btn);
    if (i % 3 === 0) clavier.appendChild(document.createElement("br"));
  }
  const zero = document.createElement("button");
  zero.textContent = "0";
  zero.onclick = () => { input.value = 0; hideKeyboard(); };
  clavier.appendChild(zero);
  const close = document.createElement("button");
  close.textContent = "✕";
  close.onclick = hideKeyboard;
  clavier.appendChild(close);
  const rect = input.getBoundingClientRect();
  clavier.style.left = rect.left + window.scrollX + 'px';
  clavier.style.top = rect.bottom + window.scrollY + 'px';
  clavier.style.display = 'block';
}

function hideKeyboard() {
  document.getElementById('clavier').style.display = 'none';
}
</script>

</body>
</html>
